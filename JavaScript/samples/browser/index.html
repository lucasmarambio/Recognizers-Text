<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>recognizers-text | browser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://rawgit.com/lodash/lodash/4.17.4/dist/lodash.min.js"></script>
    <script src="http://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
</head>

<body>
    <h1>Browser Test</h1>

    <Label>Language: </Label>
    <select id="ddlLanguage">
            <option value="en-us" selected="selected">English</option>
            <option value="es-es">Spanish</option>
    </select>

    <br />
    <br />

    <Label>Recognizer: </Label>
    <select id="ddlRecognizer">
            <option value="Number" selected="selected">Number</option>
            <option value="NumberOrdinal">Number - Ordinal</option>
            <option value="NumberPercentage">Number - Percentage</option>
            <option value="NumberWithUnitCurrency">Number with Unit - Currency</option>
            <option value="NumberWithUnitTemperature">Number with Unit - Temperature</option>
            <option value="NumberWithUnitDimension">Number with Unit - Dimension</option>
            <option value="NumberWithUnitAge">Number with Unit - Age</option>
            <option value="DateTime">DateTime</option>
    </select>

    <br />
    <br />

    <form id="parse">
        <label>
            Input:
            <input type="text" id="input" value="I have twenty apples" />
            <input type="submit" value="Parse" />
        </label>
    </form>

    <br /> Result:
    <pre id="output">
    </pre>

    <script>
        require(["../../dist/recognizers-text.umd.js"], function (Recognizers) {

            document.getElementById("parse").addEventListener("submit", function (e) {
                e.preventDefault();
                var result = parse(document.getElementById("input").value);

                var output = JSON.stringify(result, null, "\t");
                document.getElementById("output").innerHTML = output;
            });

            function parse(input) {
                var model;
                var language = document.getElementById("ddlLanguage");
                var recognizer = document.getElementById("ddlRecognizer");
                var culture = language.options[language.selectedIndex].value;
                var selectedRecognizer = recognizer.options[recognizer.selectedIndex].value;

                switch (selectedRecognizer) {
                    case "Number":
                        model = Recognizers.NumberRecognizer.instance.getNumberModel(culture);
                        break;
                    case "NumberOrdinal":
                        model = Recognizers.NumberRecognizer.instance.getOrdinalModel(culture);
                        break;
                    case "NumberPercentage":
                        model = Recognizers.NumberRecognizer.instance.getPercentageModel(culture);
                        break;
                    case "NumberWithUnitCurrency":
                        model = Recognizers.NumberWithUnitRecognizer.instance.getCurrencyModel(culture);
                        break;
                    case "NumberWithUnitTemperature":
                        model = Recognizers.NumberWithUnitRecognizer.instance.getTemperatureModel(culture);
                        break;
                    case "NumberWithUnitDimension":
                        model = Recognizers.NumberWithUnitRecognizer.instance.getDimensionModel(culture);
                        break;
                    case "NumberWithUnitAge":
                        model = Recognizers.NumberWithUnitRecognizer.instance.getAgeModel(culture);
                        break;
                    case "DateTime":
                        model = Recognizers.DateTimeRecognizer.instance.getDateTimeModel(culture);
                        break;
                }

                // Show result
                var result = model.parse(input);

                // Format for DateTimes
                result.forEach(r => {
                    if(!r.resolution || !r.resolution.get) return;
                    r.resolution = r.resolution.get('values').map(toObject);
                });

                return result;
            }

            // first time trigger
            document.getElementById("parse").dispatchEvent(new Event("submit", {
                'bubbles': true,
                'cancelable': true
            }));

            // helpers
            function toObject(map) {
                if (!map) return undefined;
                var keys = Array.from(map.keys());
                var values = Array.from(map.values()).map(asString);
                return _.zipObject(keys, values);
            }

            function asString(o) {
                if (!o) return o;

                if (_.isNumber(o)) {
                    return o.toString();
                }

                if (_.isDate(o)) {
                    var isoDate = new Date(o.getTime() - o.getTimezoneOffset() * 60000).toISOString();
                    var parts = isoDate.split('T');
                    var time = parts[1].split('.')[0].replace('00:00:00', '');
                    return [parts[0], time].join(' ').trim();
                }

                // JS min Date is 1901, while .NET is 0001
                if (o === '1901-01-01') {
                    return '0001-01-01';
                }

                return o;
            }

        })
    </script>
</body>

</html>